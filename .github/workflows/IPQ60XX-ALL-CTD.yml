name: IPQ60XX-ALL-CTD

on:
  workflow_dispatch:
  schedule:
    # Ch·∫°y t·ª± ƒë·ªông m·ªói ng√†y l√∫c 02:00 s√°ng (UTC+7)
    - cron: 0 19 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: main-nss
  CONFIG_FILE: configs/ipq60xx.config
  DIY_SCRIPT: diy-script.sh
  CLASH_KERNEL: amd64
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-ALL
  TZ: Asia/Ho_Chi_Minh

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: Ki·ªÉm tra t√†i nguy√™n m√°y build (CPU / RAM / Disk)
      run: |
        echo "‚ö†Ô∏è C·∫£nh b√°o"
        echo "M√°y GitHub Actions c√≥ t√†i nguy√™n gi·ªõi h·∫°n."
        echo "N·∫øu ch·ªçn qu√° nhi·ªÅu package, c√≥ th·ªÉ g√¢y ch·∫≠m ho·∫∑c l·ªói build."
        echo -e "C√°c CPU th∆∞·ªùng g·∫∑p (t·ª´ m·∫°nh ƒë·∫øn y·∫øu): 7763, 8370C, 8272CL, 8171M, E5-2673 \n"
        echo "---------------- Th√¥ng tin CPU ----------------"
        echo "S·ªë CPU v·∫≠t l√Ω: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "Th√¥ng tin core:\n$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)\n"
        echo "---------------- Th√¥ng tin RAM ----------------"
        sudo lshw -short -C memory | grep GiB
        echo "---------------- Th√¥ng tin ·ªï ƒëƒ©a ----------------"
        echo "S·ªë ·ªï ƒëƒ©a: $(ls /dev/sd* | grep -v [1-9] | wc -l)"
        df -hT

    - name: Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng build
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # X√≥a Docker image c≈©
        docker rmi $(docker images -q) || true

        # D·ªçn d·∫πp c√°c th√†nh ph·∫ßn kh√¥ng c·∫ßn thi·∫øt
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* \
          powershell openjdk* mongodb* moby* || true

        # C√†i ƒë·∫∑t ph·ª• thu·ªôc c·∫ßn thi·∫øt cho OpenWrt
        sudo -E apt-get update
        sudo -E apt-get install -y $(curl -fsSL is.gd/depends_ubuntu_2204)

        # D·ªçn r√°c h·ªá th·ªëng
        sudo -E systemctl daemon-reload
        sudo -E apt-get autoremove --purge -y
        sudo -E apt-get clean

        # Thi·∫øt l·∫≠p m√∫i gi·ªù Vi·ªát Nam
        sudo timedatectl set-timezone "$TZ"

    - name: M·ªü r·ªông dung l∆∞·ª£ng build (gh√©p ·ªï ƒëƒ©a)
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    - name: Checkout repository workflow
      uses: actions/checkout@main

    - name: Clone m√£ ngu·ªìn OpenWrt
      run: |
        df -hT $GITHUB_WORKSPACE
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

        # L·∫•y th√¥ng tin commit m·ªõi nh·∫•t
        VERSION_INFO=$(git show -s --date=short --format="T√°c gi·∫£: %an<br/>Th·ªùi gian: %cd<br/>N·ªôi dung: %s<br/>Hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

        # L·∫•y phi√™n b·∫£n kernel
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' include/kernel-6.6)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

        # L·∫•y log commit trong 24h g·∫ßn nh·∫•t
        if git log --since="$(date -d 'yesterday 00:00' '+%Y-%m-%dT%H:%M:%S')" \
                   --until="$(date -d 'today 00:00' '+%Y-%m-%dT%H:%M:%S')" \
                   --pretty=format:"%h %s" --no-merges -- . ':(exclude)scripts/feeds' | grep -q .; then
          VERSION_LOG=$(git log --since="$(date -d 'yesterday 00:00' '+%Y-%m-%dT%H:%M:%S')" \
                                --until="$(date -d 'today 00:00' '+%Y-%m-%dT%H:%M:%S')" \
                                --pretty=format:"%h %s" --no-merges -- . ':(exclude)scripts/feeds')
          echo "VERSION_LOG=$VERSION_LOG" >> $GITHUB_ENV
        else
          echo "VERSION_LOG=Kh√¥ng c√≥ c·∫≠p nh·∫≠t" >> $GITHUB_ENV
        fi

    - name: T·∫°o bi·∫øn m√¥i tr∆∞·ªùng t·ª´ file c·∫•u h√¨nh
      run: |
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1

        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV

        DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV

        DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

    - name: Cache toolchain (tƒÉng t·ªëc build)
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: C·∫≠p nh·∫≠t v√† c√†i ƒë·∫∑t feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: N·∫°p c·∫•u h√¨nh t√πy ch·ªânh
      run: |
        [ -e files ] && mv files $OPENWRT_PATH/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_PATH/.config

    - name: T·∫£i source c√°c package (dl)
      run: |
        cd $OPENWRT_PATH
        make defconfig
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Bi√™n d·ªãch firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "S·ªë lu·ªìng build: $(nproc)"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Ki·ªÉm tra dung l∆∞·ª£ng sau build
      if: (!cancelled())
      run: df -hT

    - name: S·∫Øp x·∫øp file firmware
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        cat sha256sums
        cp $OPENWRT_PATH/.config build.config
        mv $OPENWRT_PATH/bin/packages/*/*/*.apk packages
        tar -zcf Packages.tar.gz packages
        rm -rf packages feeds.buildinfo version.buildinfo
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

    - name: Ph√°t h√†nh firmware l√™n GitHub Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} cho ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **OpenWrt Firmware cho ${{ env.FIRMWARE_TAG }}**
          ### üìí Th√¥ng tin firmware
          - Kernel Linux 6.6, c√≥ Wi-Fi v√† NSS
          - N·ªÅn t·∫£ng: ${{ env.FIRMWARE_TAG }}
          - M√£ ngu·ªìn: ${{ env.REPO_URL }}
          - Nh√°nh: ${{ env.REPO_BRANCH }}
          - IP m·∫∑c ƒë·ªãnh: 192.168.1.1
          - M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: password
          ### üßä Phi√™n b·∫£n
          - Kernel: ${{ env.VERSION_KERNEL }}
          - C·∫≠p nh·∫≠t m√£ ngu·ªìn g·∫ßn nh·∫•t:
            ${{ env.VERSION_INFO }}
          - Log thay ƒë·ªïi:
            ${{ env.VERSION_LOG }}
